name: Build

inputs:
  go_version:
    required: true
  ipxe_ref:
    required: true

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Checkout iPXE
      uses: actions/checkout@v2
      with:
        path: ipxe
        repository: ipxe/ipxe
        ref: ${{ inputs.ipxe_ref }}

    - name: Cache iPXE ROMs
      uses: actions/cache@v2
      with:
        path: |
          ipxe/src/bin
          ipxe/src/bin-x86_64-efi
          ipxe/src/bin-i386-efi
        key: ipxe-${{ inputs.ipxe_ref }}
      id: cache

    - name: Setup Go
      uses: actions/setup-go@v2
      with:
        go-version: ${{ inputs.go_version }}

    - name: Build iPXE ROMs
      run: |
        if [[ "${{ steps.cache.outputs.cache-hit }}" = 'true' ]]; then
          echo "Cache hit, skipping ipxe build"
        else
          make -C ipxe/src bin/undionly.kpxe bin-x86_64-efi/ipxe.efi bin-i386-efi/ipxe.efi
        fi
      shell: bash

    - name: Go generate
      run: go generate ./...
      shell: bash
